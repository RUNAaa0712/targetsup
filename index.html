<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>チュウニズム目標管理ツール</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <div id="app" v-cloak>
        <div class="cyber-bg"></div>

        <sync-overlay
            :is-syncing="isSyncing"
            :sync-status="syncStatus"
            :sync-progress="syncProgress"
            :sync-logs="syncLogs">
        </sync-overlay>

        <slot-machine
            :is-animating="isAnimating"
            :slots="slots"
            :animation-status-text="animationStatusText">
        </slot-machine>

        <main>
            <transition name="page-fade" mode="out-in">
                <div v-if="tab === 'home'" key="home">
                    <h1 class="neon-title">システム設定</h1>
                    <div class="glass-card">
                        <div v-if="!isLoggedIn">
                            <input v-model="auth.userId" placeholder="ユーザーID (半角英数字)">
                            <input v-model="auth.password" type="password" placeholder="パスワード" style="margin-top:10px;">
                            <button @click="handleAuth('login')" class="btn-action"
                                style="margin-top:15px;">ログイン</button>
                            <button @click="handleAuth('register')" class="btn-action"
                                style="background:#444; color:#fff;">新規登録</button>
                        </div>
                        <div v-else>
                            <p>ログイン中: <span style="color:var(--cyan)">{{auth.userId}}</span></p>
                            <button @click="loadAndSync" class="btn-action">全データの同期実行</button>

                            <button @click="clearAllData" class="btn-action"
                                style="background:#d32f2f; color:#fff; margin-top:20px;">
                                データ整理 (全削除)
                            </button>

                            <button @click="logout" class="btn-action"
                                style="background:#444; color:#fff; margin-top:10px;">ログアウト</button>
                        </div>
                    </div>

                    <div class="glass-card" v-if="isLoggedIn">
                        <span class="section-label">同期対象設定 (マージ条件)</span>
                        <div class="chip-group">
                            <div v-for="s in scoreFilterList"
                                :class="['chip', {active: settings.syncScores.includes(s.label)}]"
                                @click="toggle(settings.syncScores, s.label)">{{s.label}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="d in diffList" :class="['chip', {active: settings.syncDiffs.includes(d)}]"
                                @click="toggle(settings.syncDiffs, d)">{{d}}</div>
                        </div>
                        <div class="chip-group scroll-x">
                            <div v-for="l in levelList" :class="['chip', {active: settings.syncLevels.includes(l)}]"
                                @click="toggle(settings.syncLevels, l)">{{l}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="lp in ['AJC','AJ','FC','CLEAR']"
                                :class="['chip', {active: settings.syncLamps.includes(lp)}]"
                                @click="toggle(settings.syncLamps, lp)">{{lp}}</div>
                        </div>
                        <div class="chip-group">
                            <div :class="['chip', {active: settings.excludeMasterIfUltima}]"
                                @click="settings.excludeMasterIfUltima = !settings.excludeMasterIfUltima; saveToLocal()">
                                ポゼ対象外除外（紫）
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="tab === 'data'" key="data">
                    <h1 class="neon-title">目標リスト (残り: {{remainingMusic.length}})</h1>
                    <div class="glass-card" style="padding:10px;">
                        <div class="chip-group">
                            <div v-for="d in diffList" :class="['chip', {active: filters.diffs.includes(d)}]"
                                @click="toggle(filters.diffs, d)">{{d}}</div>
                        </div>
                        <div class="chip-group scroll-x">
                            <div v-for="l in levelList" :class="['chip', {active: filters.levels.includes(l)}]"
                                @click="toggle(filters.levels, l)">{{l}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="s in scoreFilterList"
                                :class="['chip', {active: filters.scores.includes(s.label)}]"
                                @click="toggle(filters.scores, s.label)">{{s.label}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="lp in ['AJC','AJ','FC','CLEAR']"
                                :class="['chip', {active: filters.lamps.includes(lp)}]"
                                @click="toggle(filters.lamps, lp)">{{lp}}</div>
                        </div>
                    </div>
                    <div v-for="s in filteredMusic" :key="s.id" class="song-item"
                        :style="{borderLeftColor: s.level==='ULTIMA' ? 'var(--ultima)' : (s.level==='MASTER' ? 'var(--master)' : '#333')}">
                        <img :src="s.image">
                        <div class="song-info">
                            <span class="song-title">{{ s.title }}</span>
                            <div style="font-size:10px; color:#888;">{{ s.level }} {{ s.levelStr }} | C: {{ s.const }}
                                <span v-if="s.lamp" :class="['lamp-badge', s.lamp]">{{ s.lamp }}</span>
                            </div>
                        </div>
                        <div class="score-val">{{ s.score.toLocaleString() }}</div>
                        <div class="check-btn" @click="toggleAchievement(s)">✔</div>
                    </div>
                </div>

                <div v-else-if="tab === 'history'" key="history">
                    <h1 class="neon-title">達成済み ({{ achievedMusic.length }})</h1>
                    <button @click="resetAchievements"
                        style="width:100%; padding:12px; background:#444; border:none; border-radius:8px; color:#fff; margin-bottom:15px; font-size:12px; font-weight:bold;">履歴をリセット</button>
                    <div v-for="s in achievedMusic" :key="s.id" class="song-item" style="opacity:0.6;">
                        <img :src="s.image">
                        <div class="song-info">
                            <span class="song-title">{{ s.title }}</span>
                            <div style="font-size:10px; color:#888;">{{ s.level }} {{ s.levelStr }}</div>
                        </div>
                        <div class="check-btn checked" @click="toggleAchievement(s)">✔</div>
                    </div>
                </div>

                <div v-else-if="tab === 'target'" key="target">
                    <h1 class="neon-title">ミッション抽選</h1>
                    <div class="glass-card">
                        <span class="section-label">ジャンル選択</span>
                        <div class="chip-group scroll-x">
                            <div v-for="g in genres" :class="['chip', {active: target.genres.includes(g)}]"
                                @click="toggle(target.genres, g)">{{g}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="d in diffList" :class="['chip', {active: target.diffs.includes(d)}]"
                                @click="toggle(target.diffs, d)">{{d}}</div>
                        </div>
                        <div class="chip-group scroll-x">
                            <div v-for="l in levelList" :class="['chip', {active: target.levels.includes(l)}]"
                                @click="toggle(target.levels, l)">{{l}}</div>
                        </div>
                        <div class="chip-group">
                            <div v-for="lp in ['AJC','AJ','FC','CLEAR']"
                                :class="['chip', {active: target.lamps.includes(lp)}]"
                                @click="toggle(target.lamps, lp)">{{lp}}</div>
                        </div>

                        <div style="margin:20px 0; display:flex; align-items:center; gap:20px;">
                            <span style="font-size:14px; font-weight:bold; color:var(--cyan);">抽選曲数:</span>
                            <input type="number" v-model.number="drawCount" min="1" max="10"
                                style="width:70px; text-align:center;" @change="saveToLocal">
                        </div>

                        <div
                            style="margin-bottom: 20px; display:flex; align-items:center; justify-content:center; gap:8px;">
                            <input type="checkbox" id="animToggle" v-model="enableAnimation" style="width:auto;">
                            <label for="animToggle"
                                style="color:#aaa; font-size:12px; cursor:pointer;">スロット演出を有効にする</label>
                        </div>
                        <button @click="drawLottery" class="btn-mission">ミッション開始</button>
                    </div>

                    <div v-for="r in results" :key="r.id" class="song-item"
                        :style="{borderLeftColor: r.level==='ULTIMA' ? 'var(--ultima)' : (r.level==='MASTER' ? 'var(--master)' : '#333')}">
                        <img :src="r.image">
                        <div class="song-info">
                            <span class="song-title">{{ r.title }}</span>
                            <div style="font-size:10px; color:#888;">
                                {{ r.level }} {{ r.levelStr }} | C: {{ r.const }}
                                <span v-if="r.lamp" :class="['lamp-badge', r.lamp]">{{ r.lamp }}</span>
                            </div>
                            <div style="font-size:9px; color:#666; margin-top:2px;">{{ r.genre }}</div>
                        </div>
                        <div class="score-val">{{ r.score.toLocaleString() }}</div>
                    </div>
                </div>

                <div v-else-if="tab === 'chart'" key="chart">
                    <h1 class="neon-title">My定数表</h1>

                    <div class="glass-card" style="padding: 10px;">
                        <span class="section-label">マーク条件 (枠線強調)</span>
                        <div class="chip-group">
                            <div v-for="t in ['rank','lamp','score']"
                                :class="['chip', {active: chartSettings.mark.type === t}]"
                                @click="chartSettings.mark.type = t">{{t==='rank'?'ランク':t==='lamp'?'ランプ':'スコア'}}</div>
                        </div>
                        <div v-if="chartSettings.mark.type === 'rank'" class="chip-group scroll-x">
                            <div v-for="r in chartOptions.rankList"
                                :class="['chip', {active: chartSettings.mark.value === r}]"
                                @click="chartSettings.mark.value = r">{{r}}</div>
                        </div>
                        <div v-if="chartSettings.mark.type === 'lamp'" class="chip-group">
                            <div v-for="l in chartOptions.lampList"
                                :class="['chip', {active: chartSettings.mark.value === l}]"
                                @click="chartSettings.mark.value = l">{{l}}</div>
                        </div>
                        <div v-if="chartSettings.mark.type === 'score'"><input type="number"
                                v-model.number="chartSettings.specific.mark" class="score-input"></div>
                        <div class="chip-group">
                            <div :class="['chip', {active: chartSettings.mark.achieved === 'true'}]"
                                @click="chartSettings.mark.achieved = 'true'">達成している</div>
                            <div :class="['chip', {active: chartSettings.mark.achieved === 'false'}]"
                                @click="chartSettings.mark.achieved = 'false'">していない</div>
                        </div>

                        <span class="section-label" style="margin-top:10px;">表示条件 (フィルタ)</span>
                        <div class="chip-group">
                            <div v-for="t in ['rank','lamp','score']"
                                :class="['chip', {active: chartSettings.display.type === t}]"
                                @click="chartSettings.display.type = t">{{t==='rank'?'ランク':t==='lamp'?'ランプ':'スコア'}}
                            </div>
                        </div>
                        <div v-if="chartSettings.display.type === 'rank'" class="chip-group scroll-x">
                            <div v-for="r in chartOptions.rankList"
                                :class="['chip', {active: chartSettings.display.value === r}]"
                                @click="chartSettings.display.value = r">{{r}}</div>
                        </div>
                        <div v-if="chartSettings.display.type === 'lamp'" class="chip-group">
                            <div v-for="l in chartOptions.lampList"
                                :class="['chip', {active: chartSettings.display.value === l}]"
                                @click="chartSettings.display.value = l">{{l}}</div>
                        </div>
                        <div v-if="chartSettings.display.type === 'score'"><input type="number"
                                v-model.number="chartSettings.specific.display" class="score-input"></div>
                        <div class="chip-group">
                            <div :class="['chip', {active: chartSettings.display.achieved === 'true'}]"
                                @click="chartSettings.display.achieved = 'true'">表示する</div>
                            <div :class="['chip', {active: chartSettings.display.achieved === 'false'}]"
                                @click="chartSettings.display.achieved = 'false'">表示しない</div>
                        </div>

                        <span class="section-label" style="margin-top:10px;">表示内容 (オーバーレイ)</span>
                        <div class="chip-group">
                            <div v-for="c in chartOptions.contentList"
                                :class="['chip', {active: chartSettings.content.mode === c.value}]"
                                @click="chartSettings.content.mode = c.value">{{c.label}}</div>
                        </div>
                        <div v-if="chartSettings.content.mode === 'base'" class="chip-group scroll-x">
                            <div v-for="r in chartOptions.rankList"
                                :class="['chip', {active: chartSettings.content.baseRank === r}]"
                                @click="chartSettings.content.baseRank = r">{{r}}基準</div>
                        </div>
                    </div>

                    <div style="padding-bottom:100px;">
                        <div v-for="group in groupedByConst" :key="group.constVal"
                            style="margin-bottom:15px; content-visibility: auto; contain-intrinsic-size: 1px 200px;">

                            <div class="const-header">
                                {{ group.constVal }} <span style="font-size:9px; color:#444;">({{ group.songs.length
                                    }})</span>
                            </div>

                            <div class="chart-grid">
                                <div v-for="s in group.songs" :key="s.id" class="chart-item" :style="{
                                        border: checkCondition(s, chartSettings.mark, chartSettings.specific.mark) ? '1.5px solid var(--cyan)' : 'none',
                                        boxShadow: checkCondition(s, chartSettings.mark, chartSettings.specific.mark) ? '0 0 8px var(--cyan)' : 'none'
                                     }">
                                    <div :class="['diff-badge', s.level]"></div>
                                    <img :src="s.image" class="chart-img" loading="lazy" decoding="async">

                                    <div class="chart-overlay">
                                        <div v-if="chartSettings.content.mode === 'rank' || chartSettings.content.mode === 'both'"
                                            class="overlay-text bold">{{ getRank(s.score) }}</div>
                                        <div v-if="chartSettings.content.mode === 'lamp'" class="overlay-text small">{{
                                            s.lamp }}</div>
                                        <div v-if="chartSettings.content.mode === 'score' || chartSettings.content.mode === 'both'"
                                            class="overlay-text">{{ s.score.toLocaleString() }}</div>
                                        <div v-if="chartSettings.content.mode === 'base'" class="overlay-text"
                                            :style="{color: (s.score - getRankThreshold(chartSettings.content.baseRank)) >= 0 ? '#00ff00' : '#ff5555'}">
                                            {{ (s.score - getRankThreshold(chartSettings.content.baseRank)) >= 0 ? '+' :
                                            '' }}{{ (s.score -
                                            getRankThreshold(chartSettings.content.baseRank)).toLocaleString() }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="tab === 'rating'" key="rating" class="rating-page">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn-action" @click="generateRatingImage">
                            画像を生成して保存
                        </button>
                    </div>

                    <div id="rating-full-capture" class="capture-container">
                        <div class="rating-header-meta">
                            <div class="generate-date">GENERATE: {{ new Date().toLocaleString() }}</div>
                        </div>

                        <h1 class="neon-title" style="margin-top:0;">CHUNITHM RATING ANALYSIS</h1>

                        <div class="glass-card rating-header-card">
                            <span class="section-label">TOTAL RATING</span>
                            <div class="total-rating-value">{{ ratingFrames.total }}</div>
                            <div class="rating-sub-info">
                                BEST Avg: {{ ratingFrames.bestAvg }} | NEW Avg: {{ ratingFrames.newAvg }}
                            </div>
                        </div>

                        <h2 class="section-label frame-title best-frame-color">BEST FRAME (TOP 30)</h2>
                        <div class="rating-grid">
                            <div v-for="(s, i) in ratingFrames.best" :key="'best-'+i" class="rating-card"
                                :class="s.level">
                                <div class="card-rank">#{{ i + 1 }}</div>
                                <img :src="s.image" class="card-jacket" crossorigin="anonymous">
                                <div class="card-info">
                                    <div class="card-title">{{ s.title }}</div>
                                    <div class="card-meta">{{ s.level }} {{ s.levelStr }} | C: {{ s.const }}</div>
                                    <div class="card-score">{{ s.score.toLocaleString() }}</div>
                                    <div class="card-rating">{{ s.rating.toFixed(4) }}</div>
                                </div>
                            </div>
                        </div>

                        <h2 class="section-label frame-title new-frame-color" style="margin-top:30px;">NEW FRAME (TOP
                            20)</h2>
                        <div class="rating-grid">
                            <div v-for="(s, i) in ratingFrames.new" :key="'new-'+i" class="rating-card"
                                :class="s.level">
                                <div class="card-rank">#{{ i + 1 }}</div>
                                <img :src="s.image" class="card-jacket" crossorigin="anonymous">
                                <div class="card-info">
                                    <div class="card-title">{{ s.title }}</div>
                                    <div class="card-meta">{{ s.level }} {{ s.levelStr }} | C: {{ s.const }}</div>
                                    <div class="card-score">{{ s.score.toLocaleString() }}</div>
                                    <div class="card-rating">{{ s.rating.toFixed(4) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <span style="color:var(--cyan); font-weight:bold;">GENERATED ANALYSIS</span>
                    <button class="modal-close-x" @click="showModal = false">×</button>
                </div>
                <div class="modal-body">
                    <img :src="generatedImage" class="result-img-preview">
                    <p class="modal-tip">※画像を長押しして保存してください</p>
                </div>
                <button @click="showModal = false" class="btn-action"
                    style="margin-top:10px; background:#333; color:#fff;">閉じる</button>
            </div>
        </div>

        <nav-bar :tab="tab" @update:tab="tab = $event"></nav-bar>
    </div>

    <script type="module" src="js/app.js"></script>
</body>

</html>